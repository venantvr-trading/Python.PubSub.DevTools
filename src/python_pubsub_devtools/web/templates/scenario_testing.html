<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Scenario Testing Dashboard</title>
    <link href="{{ url_for('static', filename='css/dashboard_common.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/pubsub_status.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/scenario_testing.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.0/dist/apexcharts.min.js"></script>
</head>
<body>
<div class="control-buttons">
    <button class="control-btn" id="dark-mode-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode (D)">
        üåô
    </button>
</div>

<div class="container">
    {% include '_header.html' %}

    {% include '_navbar.html' %}

    <div class="content">
        {% include '_pubsub_status.html' %}

        <!-- Main Tabs -->
        <div class="main-tab-container">
            <div class="main-tab active" onclick="switchMainTab('quickstart')">üöÄ Quick Start</div>
            <div class="main-tab" onclick="switchMainTab('risk')">üìä Analyse de Risque</div>
        </div>

        <!-- Tab Content: Quick Start -->
        <div class="main-tab-content active" id="main-tab-quickstart">
            <div class="card">
                <h2>üìä Quick Start Scenarios</h2>
                <p>Sc√©narios de test pr√™ts √† l'emploi - Cliquez pour d√©marrer imm√©diatement</p>

                <div class="scenarios-grid">
                    <div class="scenario-card" onclick="quickStartScenario('bull_run_50_candles.json')">
                        <div class="scenario-icon">üìà</div>
                        <div class="scenario-name">Bull Run</div>
                        <div class="scenario-desc">50 candles ‚Ä¢ Tendance haussi√®re forte</div>
                        <div class="scenario-price">$30K ‚Üí $37.6K</div>
                    </div>

                    <div class="scenario-card" onclick="quickStartScenario('bear_market_50_candles.json')">
                        <div class="scenario-icon">üìâ</div>
                        <div class="scenario-name">Bear Market</div>
                        <div class="scenario-desc">50 candles ‚Ä¢ Tendance baissi√®re</div>
                        <div class="scenario-price">$40K ‚Üí $33.9K</div>
                    </div>

                    <div class="scenario-card" onclick="quickStartScenario('sideways_50_candles.json')">
                        <div class="scenario-icon">‚ÜîÔ∏è</div>
                        <div class="scenario-name">Sideways</div>
                        <div class="scenario-desc">50 candles ‚Ä¢ Consolidation range</div>
                        <div class="scenario-price">$34K - $36K</div>
                    </div>

                    <div class="scenario-card" onclick="quickStartScenario('flash_crash_60_candles.json')">
                        <div class="scenario-icon">‚ö°</div>
                        <div class="scenario-name">Flash Crash</div>
                        <div class="scenario-desc">60 candles ‚Ä¢ Crash + r√©cup√©ration</div>
                        <div class="scenario-price">$38K ‚Üí $21K ‚Üí $33K</div>
                    </div>

                    <div class="scenario-card" onclick="quickStartScenario('volatile_40_candles.json')">
                        <div class="scenario-icon">üå™Ô∏è</div>
                        <div class="scenario-name">High Volatility</div>
                        <div class="scenario-desc">40 candles ‚Ä¢ Mouvements chaotiques</div>
                        <div class="scenario-price">Haute volatilit√©</div>
                    </div>
                </div>

                <div class="scenario-controls">
                    <label>Mode replay rapide:</label>
                    <select id="quick-mode-select">
                        <option value="pull">Pull Mode</option>
                        <option selected value="push">Push Mode</option>
                    </select>
                    <label>Intervalle:</label>
                    <select id="quick-interval-select">
                        <option value="0.5">0.5s (rapide)</option>
                        <option selected value="1">1s</option>
                        <option value="2">2s</option>
                        <option value="3">3s</option>
                    </select>
                </div>
            </div>

            <div class="info-box">
                üí° Ou s√©lectionnez un sc√©nario YAML avanc√© ci-dessous pour tests avec assertions
            </div>

            <div class="grid-container">
                <!-- Left: Scenarios list -->
                <div class="panel">
                    <div class="panel-title">üìã Available Scenarios</div>
                    <div class="scenarios-list" id="scenarios-list">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            Loading scenarios...
                        </div>
                    </div>
                </div>

                <!-- Right: Configuration and execution -->
                <div class="panel">
                    <div class="panel-title">‚öôÔ∏è Test Configuration</div>

                    <div id="scenario-config" style="display: none;">
                        <div class="control-group">
                            <label class="control-label">Selected Scenario</label>
                            <div id="selected-scenario-name" style="font-weight: 600; color: #667eea;">-</div>
                        </div>

                        <div class="tab-container">
                            <div class="tab active" onclick="switchTab('preview')">Preview</div>
                            <div class="tab" onclick="switchTab('config')">Configuration</div>
                        </div>

                        <div class="tab-content active" id="tab-preview">
                            <div class="scenario-preview" id="scenario-preview">
                                Select a scenario to see its configuration
                            </div>
                        </div>

                        <div class="tab-content" id="tab-config">
                            <div class="control-group">
                                <label class="control-label">Verbose Output</label>
                                <input id="verbose-checkbox" type="checkbox"> Enable verbose logging
                            </div>
                            <div class="control-group">
                                <label class="control-label">Save Recording</label>
                                <input checked id="recording-checkbox" type="checkbox"> Record events during execution
                            </div>
                        </div>

                        <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-primary" id="run-btn" onclick="runTest()">‚ñ∂Ô∏è Run Test</button>
                            <button class="btn btn-danger" disabled id="stop-btn" onclick="stopTest()">‚èπ Stop</button>
                            <span class="status-badge status-idle" id="status-badge">‚óè Idle</span>
                        </div>
                    </div>

                    <div id="no-scenario" style="text-align: center; color: #6c757d; padding: 40px;">
                        ‚Üê Select a scenario to configure and run
                    </div>
                </div>
            </div>

            <!-- Results section -->
            <div id="results-section" style="display: none;">
                <div class="panel execution-panel">
                    <div class="panel-title">üìä Execution Results</div>

                    <div class="results-grid">
                        <div class="stat-card">
                            <div class="stat-label">Status</div>
                            <div class="stat-value" id="result-status">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Duration</div>
                            <div class="stat-value" id="result-duration">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Assertions Passed</div>
                            <div class="stat-value success" id="result-assertions">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Events Recorded</div>
                            <div class="stat-value" id="result-events">-</div>
                        </div>
                    </div>

                    <div class="tab-container">
                        <div class="tab active" onclick="switchResultTab('log')">Execution Log</div>
                        <div class="tab" onclick="switchResultTab('assertions')">Assertions</div>
                        <div class="tab" onclick="switchResultTab('chaos')">Chaos Report</div>
                    </div>

                    <div class="tab-content active" id="result-tab-log">
                        <div class="execution-log" id="execution-log">
                            <div class="log-entry log-info">Waiting for test execution...</div>
                        </div>
                    </div>

                    <div class="tab-content" id="result-tab-assertions">
                        <div class="assertions-list" id="assertions-list">
                            No assertions to display yet
                        </div>
                    </div>

                    <div class="tab-content" id="result-tab-chaos">
                        <div class="chaos-config" id="chaos-report">
                            No chaos report available yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END Quick Start Tab -->

        <!-- Tab Content: Risk Analysis -->
        <div class="main-tab-content" id="main-tab-risk">
            <div class="risk-analysis-layout">
                <!-- Sidebar de Contr√¥le -->
                <div class="risk-sidebar">
                    <h3 class="sidebar-title">Panneau de Contr√¥le</h3>

                    <!-- Section 0: Upload -->
                    <div class="control-section">
                        <h4>0Ô∏è‚É£ Ingestion des Donn√©es</h4>
                        <p class="section-desc">Chargez un fichier CSV avec colonnes: timestamp, open, high, low, close, volume</p>
                        <div class="control-group">
                            <label class="control-label">Fichier CSV (OHLCV)</label>
                            <input accept=".csv" class="file-input" id="file-upload-risk" type="file">
                        </div>
                        <div class="status-text" id="file-status-risk">Aucun fichier charg√©</div>
                    </div>

                    <!-- Section 1: HMM -->
                    <div class="control-section">
                        <h4>1Ô∏è‚É£ Le Cerveau (HMM)</h4>
                        <p class="section-desc">Mod√®le de Markov cach√© pour identifier automatiquement les r√©gimes (Bull/Bear/Sideways) selon volatilit√© et rendements</p>
                        <button class="btn btn-primary" disabled id="btn-train-hmm">üß† Lancer l'identification</button>
                        <div class="status-text" id="hmm-status">√âtat : Inactif</div>
                        <ul class="regime-list" id="hmm-regimes"></ul>
                    </div>

                    <!-- Section 2: GANs -->
                    <div class="control-section">
                        <h4>2Ô∏è‚É£ Les Artistes (TimeGANs)</h4>
                        <p class="section-desc">R√©seau g√©n√©ratif qui apprend les patterns de chaque r√©gime pour cr√©er des s√©quences r√©alistes de bougies</p>
                        <div class="control-group">
                            <label class="control-label">R√©gime cible</label>
                            <select class="control-input" disabled id="gan-regime-select">
                                <option>S√©lectionner un r√©gime</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" disabled id="btn-train-gan">üé® Entra√Æner le GAN</button>
                        <div class="status-text" id="gan-status"></div>
                    </div>

                    <!-- Section 3: Simulation -->
                    <div class="control-section">
                        <h4>3Ô∏è‚É£ G√©n√©ration des Sc√©narios</h4>
                        <p class="section-desc">Monte Carlo: g√©n√®re N trajectoires futures en m√©langeant les r√©gimes selon leurs probabilit√©s (GBM ou GAN)</p>
                        <div class="control-group">
                            <label class="control-label">Nombre de simulations</label>
                            <input class="control-input" id="sim-count" max="10000" min="100" type="number" value="1000">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Horizon (bougies)</label>
                            <input class="control-input" id="sim-horizon" max="1000" min="10" type="number" value="240">
                        </div>
                        <button class="btn btn-primary btn-large" id="btn-run-sim">‚ñ∂Ô∏è LANCER LA SIMULATION</button>
                        <div class="spinner hidden" id="sim-loader"></div>
                    </div>
                </div>

                <!-- Zone Principale -->
                <div class="risk-main">
                    <!-- Sub Tabs -->
                    <div class="sub-tab-container">
                        <div class="sub-tab active" onclick="switchSubTab('live')">üìà √âtat Actuel</div>
                        <div class="sub-tab" onclick="switchSubTab('results')">üìä R√©sultats de Simulation</div>
                    </div>

                    <!-- Sub Tab: √âtat Actuel -->
                    <div class="sub-tab-content active" id="sub-tab-live">
                        <div class="regime-badge hidden" id="current-regime-badge">
                            R√âGIME ACTUEL : <span id="regime-name">-</span> (Prob: <span id="regime-prob">0</span>%)
                        </div>
                        <div class="chart-container">
                            <h3>üìà Derni√®res 200 Bougies</h3>
                            <div id="chart-live" style="width: 100%; height: 400px;"></div>
                        </div>
                    </div>

                    <!-- Sub Tab: R√©sultats -->
                    <div class="sub-tab-content" id="sub-tab-results">
                        <h3>R√©sultats de Simulation</h3>

                        <!-- Explorateur de Sc√©narios -->
                        <div class="chart-container">
                            <div class="explorer-controls">
                                <button class="btn btn-secondary" disabled id="btn-prev-sim">‚Üê Pr√©c√©dent</button>
                                <span id="sim-counter">Sc√©nario 0 / 0</span>
                                <button class="btn btn-secondary" disabled id="btn-next-sim">Suivant ‚Üí</button>
                            </div>
                            <div id="chart-simulation" style="width: 100%; height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END Risk Analysis Tab -->
    </div>

    {% include '_footer.html' %}
</div>

<button class="refresh-btn" onclick="location.reload()" title="Refresh">
    ‚Üª
</button>

<script src="{{ url_for('static', filename='js/pubsub_status.js') }}"></script>
<script src="{{ url_for('static', filename='js/scenario_testing.js') }}"></script>
</body>
</html>
