<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Event Recorder Dashboard</title>
    <link href="{{ url_for('static', filename='css/dashboard_common.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/event_recorder.css') }}" rel="stylesheet">
</head>
<body>
<div class="control-buttons">
    <button class="control-btn record-btn" id="record-btn" onclick="showRecordInfo()" title="Start Recording (requires ServiceBus connection)">
        ‚è∫Ô∏è
    </button>
    <button class="control-btn" id="dark-mode-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode (D)">
        üåô
    </button>
    <button class="control-btn" id="info-btn" onclick="showInfo()" title="Info & Help">
        ‚ÑπÔ∏è
    </button>
</div>

<div class="container">
    {% include '_header.html' %}

    {% include '_navbar.html' %}

    <!-- Replay Status Banner (hidden by default) -->
    <div class="replay-status-banner" id="replay-status-banner" style="display: none;">
        <div class="replay-status-info">
            <span class="replay-status-icon">üé¨</span>
            <span class="replay-status-text" id="replay-status-text">Replaying...</span>
            <span class="replay-status-file" id="replay-status-file"></span>
            <span class="replay-progress-text" id="replay-progress-text">0 / 0</span>
        </div>
        <button class="btn btn-danger btn-sm" onclick="stopGlobalReplay()">‚èπÔ∏è Stop Replay</button>
    </div>

    <div class="content">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ total_recordings }}</div>
                <div class="stat-label">Recordings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_events }}</div>
                <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_duration }}</div>
                <div class="stat-label">Total Duration</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ avg_events_per_recording }}</div>
                <div class="stat-label">Avg Events/Recording</div>
            </div>
        </div>

        <div class="players-section">
            <h2>Registered Players</h2>
            <div class="players-list" id="players-list">
                <div class="player-empty">No players registered. Applications must register via POST /api/player/register</div>
            </div>
        </div>

        {% if recordings %}
        <div class="recordings-list">
            {% for recording in recordings %}
            <div class="recording-card" data-filename="{{ recording.filename }}" onclick="viewRecording('{{ recording.filename }}')">
                <!-- Replay Progress Indicator (hidden by default) -->
                <div class="recording-replay-indicator" style="display: none;">
                    <div class="replay-indicator-bar">
                        <div class="replay-indicator-fill"></div>
                    </div>
                    <div class="replay-indicator-text">
                        <span class="replay-indicator-status">üé¨ Replaying</span>
                        <span class="replay-indicator-progress">0%</span>
                    </div>
                </div>

                <div class="recording-header">
                    <div class="recording-name">{{ recording.session_name }}</div>
                    <div class="recording-date">{{ recording.created_at }}</div>
                </div>
                <div class="recording-stats">
                    <div class="recording-stat">
                        <span class="icon">‚è±</span>
                        <span>{{ recording.duration }}</span>
                    </div>
                    <div class="recording-stat">
                        <span class="icon">üìä</span>
                        <span>{{ recording.event_count }} events</span>
                    </div>
                    <div class="recording-stat">
                        <span class="icon">üè∑</span>
                        <span>{{ recording.unique_events }} types</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üé¨</div>
            <div class="empty-state-text">No recordings found</div>
            <div class="empty-state-hint">
                Start recording with EventRecorder to see recordings here
            </div>
        </div>
        {% endif %}
    </div>

    {% include '_footer.html' %}
</div>

<button class="refresh-btn" onclick="location.reload()" title="Refresh">
    ‚Üª
</button>

<!-- Recording Modal -->
<div class="modal" id="recording-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚è∫Ô∏è Start Recording</h2>
            <span class="close-btn" onclick="closeRecordingModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Start a new recording session to capture events from your application.</p>
            <div class="form-group">
                <label for="session-name">Session Name:</label>
                <input id="session-name" placeholder="e.g., trading_session_001" type="text"
                       value="session_{{ now.strftime('%Y%m%d_%H%M%S') if now else '' }}">
            </div>
            <div class="modal-info">
                <p><strong>üìù Note:</strong> Make sure your application ServiceBus is running with <code>enable_recording=True</code></p>
                <p><strong>üîó Or</strong> the application will send events manually to this endpoint</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRecordingModal()">Cancel</button>
            <button class="btn btn-primary" onclick="startRecording()">Start Recording</button>
        </div>
    </div>
</div>

<!-- Recording Status Bar (hidden by default) -->
<div class="recording-status-bar" id="recording-status-bar" style="display: none;">
    <div class="recording-status-content">
        <span class="recording-pulse">‚è∫Ô∏è</span>
        <span class="recording-session-name" id="recording-session-name">Recording...</span>
        <span class="recording-event-count" id="recording-event-count">0 events</span>
    </div>
    <button class="stop-recording-btn" onclick="stopRecording()">‚èπ Stop</button>
</div>

<script src="{{ url_for('static', filename='js/event_recorder.js') }}"></script>
<script>
    // Load players list
    async function loadPlayers() {
        try {
            const response = await fetch('/api/player/list');
            const data = await response.json();

            const playersList = document.getElementById('players-list');

            if (data.count === 0) {
                playersList.innerHTML = '<div class="player-empty">No players registered. Applications must register via POST /api/player/register</div>';
            } else {
                playersList.innerHTML = data.players.map(player => `
                    <div class="player-item">
                        <span class="player-name">${player.consumer_name}</span>
                        <span class="player-endpoint">${player.player_endpoint}</span>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to load players:', error);
        }
    }

    // Poll players list every 3 seconds
    document.addEventListener('DOMContentLoaded', function() {
        loadPlayers();
        setInterval(loadPlayers, 3000);
    });
</script>
</body>
</html>
