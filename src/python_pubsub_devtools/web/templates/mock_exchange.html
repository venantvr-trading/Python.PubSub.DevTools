<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>üé∞ Mock Exchange Dashboard</title>
    <link href="{{ url_for('static', filename='css/dashboard_common.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/pubsub_status.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/mock_exchange.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.0/dist/apexcharts.min.js"></script>
</head>
<body>
<div class="control-buttons">
    <button class="control-btn" id="dark-mode-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode (D)">
        üåô
    </button>
</div>

<div class="container">
    {% include '_header.html' %}

    {% include '_navbar.html' %}

    <div class="content">
        {% include '_pubsub_status.html' %}


        <div class="card file-list">
            <h2>Rejouer des Donn√©es Historiques OHLCV</h2>

            <!-- Status Bar -->
            <div class="replay-status-bar" id="replay-status-bar">
                <div class="status-indicator">
                    <span class="status-dot stopped" id="status-dot"></span>
                    <span id="status-text">STOPPED</span>
                </div>
                <div id="status-details">No active session</div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="controls" onclick="switchTab('controls')">‚öôÔ∏è Contr√¥les</button>
                <button class="tab-btn" data-tab="candles" onclick="switchTab('candles')">üìä Bougies</button>
                <button class="tab-btn" data-tab="logs" onclick="switchTab('logs')">üìù Logs</button>
            </div>

            <!-- Tab Content: Controls -->
            <div class="tab-content active" id="tab-controls">

                <div class="card-content">
                    <h3>Uploader un fichier de donn√©es</h3>
                    <form id="upload-form">
                        <input accept=".csv,.json" id="file-input" name="file" required type="file">
                        <button class="btn btn-primary" type="submit">Uploader</button>
                    </form>
                    <div id="upload-status"></div>
                </div>

                <div class="card-content">
                    <h3>Contr√¥les de Replay</h3>
                    <form id="replay-control-form" onsubmit="startReplay(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="file-select">Fichier</label>
                                <select id="file-select" name="filename" required>
                                    <option value="">-- S√©lectionner un fichier --</option>
                                    {% if replay_files %}
                                    {% for file in replay_files %}
                                    <option value="{{ file.filename }}">{{ file.filename }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mode-select">Mode</label>
                                <select id="mode-select" name="mode" onchange="togglePushOptions()" required>
                                    <option value="pull">Pull (Consumer tire)</option>
                                    <option value="push">Push (Serveur pousse)</option>
                                </select>
                            </div>
                        </div>

                        <div id="push-options" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="interval">Intervalle (secondes)</label>
                                    <input id="interval" min="0.1" name="interval_seconds" step="0.1" type="number" value="1.0">
                                </div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-success" id="start-btn" type="submit">‚ñ∂Ô∏è D√©marrer</button>
                            <button class="btn btn-danger" disabled id="stop-btn" onclick="stopReplay()" type="button">‚èπÔ∏è Arr√™ter</button>
                        </div>
                    </form>

                    <div class="info-box" id="mode-info">
                        <strong>Mode Pull:</strong> Le consumer appelle <code>GET /api/ohlcv</code> pour r√©cup√©rer les donn√©es incr√©mentalement.
                    </div>
                    <div class="info-box" id="push-mode-warning" style="display: none; background-color: #fff3cd; border-color: #ffc107;">
                        <strong>Mode Push:</strong> Les candles seront envoy√©es aux receivers enregistr√©s. Au moins un receiver doit √™tre enregistr√© pour d√©marrer.
                    </div>
                </div>

                <div class="card-content">
                    <h3>Fichiers de Replay Disponibles</h3>
                    <table id="replay-files-table">
                        <thead>
                        <tr>
                            <th>Nom du fichier</th>
                            <th>Taille (KB)</th>
                            <th>Date d'ajout</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="files-tbody">
                        {% if replay_files %}
                        {% for file in replay_files %}
                        <tr data-filename="{{ file.filename }}">
                            <td>{{ file.filename }}</td>
                            <td>{{ file.size_kb }}</td>
                            <td>{{ file.created_at }}</td>
                            <td>
                                <button class="btn-delete" data-filename="{{ file.filename }}" title="Supprimer le fichier">üóëÔ∏è</button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 2rem;">Aucun fichier de replay trouv√©. Uploadez-en un pour commencer.</td>
                        </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- End Tab Content: Controls -->

            <!-- Tab Content: Candles -->
            <div class="tab-content" id="tab-candles">
                <div class="card-content">
                    <h3>Bougies Fournies</h3>
                    <p class="info-text">Historique des bougies envoy√©es/fournies pendant le replay.</p>

                    <div class="candles-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total:</span>
                            <span class="stat-value" id="candles-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Dernier close:</span>
                            <span class="stat-value" id="last-close">-</span>
                        </div>
                    </div>

                    <!-- Candlestick Chart -->
                    <div class="chart-section">
                        <h4>Graphique Candlestick</h4>
                        <div id="candlestick-chart" style="width: 100%; height: 400px;"></div>
                    </div>

                    <!-- Data Table -->
                    <div class="table-section">
                        <h4>Donn√©es Tabulaires</h4>
                        <div class="table-wrapper">
                            <table id="candles-table">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Timestamp</th>
                                    <th>Open</th>
                                    <th>High</th>
                                    <th>Low</th>
                                    <th>Close</th>
                                    <th>Volume</th>
                                </tr>
                                </thead>
                                <tbody id="candles-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem; color: #6c757d;">
                                        Aucune bougie pour l'instant. D√©marrez un replay.
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Tab Content: Candles -->

            <!-- Tab Content: Logs -->
            <div class="tab-content" id="tab-logs">
                <div class="card-content">
                    <h3>Logs d'Activit√©</h3>
                    <p class="info-text">Journal en temps r√©el des √©v√©nements du replay.</p>

                    <div class="logs-controls">
                        <button class="btn btn-secondary btn-sm" onclick="clearLogsDisplay()">üóëÔ∏è Effacer l'affichage</button>
                        <label class="auto-scroll-label">
                            <input checked id="auto-scroll-checkbox" type="checkbox">
                            Auto-scroll
                        </label>
                    </div>

                    <div class="logs-container" id="logs-container">
                        <div class="log-entry log-info">
                            <span class="log-time">--:--:--</span>
                            <span class="log-message">En attente d'√©v√©nements...</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Tab Content: Logs -->

        </div>
    </div>

    {% include '_footer.html' %}
</div>

<script src="{{ url_for('static', filename='js/pubsub_status.js') }}"></script>
<script src="{{ url_for('static', filename='js/mock_exchange.js') }}"></script>
<script>
    // Initialize replay status polling
    document.addEventListener('DOMContentLoaded', function() {
        loadReplayStatus();
        setInterval(loadReplayStatus, 2000);  // Poll every 2 seconds

        // Initialize chart immediately
        initCandlestickChart();

        // Initialize data polling for candles and logs tabs
        loadCandles();
        setInterval(loadCandles, 2000);
        setInterval(loadLogs, 2000);

        // Poll PubSub status every 3 seconds
        loadPubSubStatus();
        setInterval(loadPubSubStatus, 3000);
    });

    // Toggle push mode options
    function togglePushOptions() {
        const mode = document.getElementById('mode-select').value;
        const pushOptions = document.getElementById('push-options');
        const modeInfo = document.getElementById('mode-info');
        const pushWarning = document.getElementById('push-mode-warning');

        if (mode === 'push') {
            pushOptions.style.display = 'block';
            modeInfo.style.display = 'none';
            pushWarning.style.display = 'block';
        } else {
            pushOptions.style.display = 'none';
            modeInfo.style.display = 'block';
            pushWarning.style.display = 'none';
        }
    }

    // Load PubSub connection status
    async function loadPubSubStatus() {
        try {
            const response = await fetch('/api/replay/status');
            const data = await response.json();

            const statusDiv = document.getElementById('pubsub-status');
            const statusIcon = statusDiv.querySelector('.status-icon');
            const statusText = statusDiv.querySelector('.status-text');

            // Check if engine has pubsub_connected field
            const pubsubConnected = data.pubsub_connected !== undefined ? data.pubsub_connected : true;

            if (pubsubConnected) {
                statusDiv.className = 'pubsub-status-indicator connected';
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = 'Service Bus connect√©';
            } else {
                statusDiv.className = 'pubsub-status-indicator disconnected';
                statusIcon.textContent = '‚ùå';
                statusText.textContent = 'Service Bus d√©connect√© - Mode Push indisponible';
            }
        } catch (error) {
            console.error('Failed to load PubSub status:', error);
            const statusDiv = document.getElementById('pubsub-status');
            statusDiv.className = 'pubsub-status-indicator disconnected';
            statusDiv.querySelector('.status-icon').textContent = '‚ùå';
            statusDiv.querySelector('.status-text').textContent = 'Service Bus d√©connect√©';
        }
    }

    // Load replay status
    let lastReplayFile = null;
    let lastReplayActive = false;
    async function loadReplayStatus() {
        try {
            const response = await fetch('/api/replay/status');
            const data = await response.json();

            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const statusDetails = document.getElementById('status-details');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            // Reset chart if new replay file OR if replay just started
            if (data.session.filename && (
                data.session.filename !== lastReplayFile ||
                (data.active && !lastReplayActive)
            )) {
                lastCandleCount = 0;
                lastReplayFile = data.session.filename;
            }

            lastReplayActive = data.active;

            if (data.active) {
                statusDot.className = 'status-dot running';
                statusText.textContent = `RUNNING (${data.session.mode} mode)`;
                statusDetails.textContent = `${data.cursor}/${data.total_candles} candles`;
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                statusDot.className = 'status-dot stopped';
                statusText.textContent = 'STOPPED';
                statusDetails.textContent = 'No active session';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        } catch (error) {
            console.error('Failed to load replay status:', error);
        }
    }

    // Start replay
    async function startReplay(event) {
        event.preventDefault();

        const filename = document.getElementById('file-select').value;
        const mode = document.getElementById('mode-select').value;
        const interval = parseFloat(document.getElementById('interval').value);

        const payload = {
            filename: filename,
            mode: mode
        };

        if (mode === 'push') {
            payload.interval_seconds = interval;
        }

        try {
            const response = await fetch('/api/replay/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                alert(`‚úÖ ${data.message}\nTotal candles: ${data.total_candles}`);
                loadReplayStatus();
            } else {
                alert(`‚ùå ${data.error}`);
            }
        } catch (error) {
            alert(`‚ùå Erreur: ${error.message}`);
        }
    }

    // Stop replay
    async function stopReplay() {
        try {
            const response = await fetch('/api/replay/stop', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                alert(`‚úÖ ${data.message}`);
                loadReplayStatus();
            } else {
                alert(`‚ùå ${data.error}`);
            }
        } catch (error) {
            alert(`‚ùå Erreur: ${error.message}`);
        }
    }

    // Tab switching
    function switchTab(tabName) {
        // Update buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');

        // Load data immediately when switching to tabs
        if (tabName === 'candles') {
            loadCandles();
        } else if (tabName === 'logs') {
            loadLogs();
        }
    }

    // Candlestick chart instance
    let candlestickChart = null;
    let lastCandleCount = 0;

    // Initialize chart
    function initCandlestickChart() {
        const chartContainer = document.getElementById('candlestick-chart');
        if (!chartContainer) return;
        if (candlestickChart) return;

        // Check if container is visible
        if (chartContainer.offsetParent === null) {
            setTimeout(initCandlestickChart, 100);
            return;
        }

        const isDark = document.body.classList.contains('dark-mode');

        const options = {
            series: [{
                name: 'candle',
                data: []
            }],
            chart: {
                type: 'candlestick',
                height: 400,
                background: isDark ? '#1a1a1a' : '#ffffff',
                foreColor: isDark ? '#e0e0e0' : '#333333',
                toolbar: {
                    show: true,
                    tools: {
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: true,
                        reset: true
                    }
                }
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    datetimeFormatter: {
                        year: 'yyyy',
                        month: 'MMM \'yy',
                        day: 'dd MMM',
                        hour: 'HH:mm'
                    }
                }
            },
            yaxis: {
                tooltip: {
                    enabled: true
                }
            },
            plotOptions: {
                candlestick: {
                    colors: {
                        upward: '#26a69a',
                        downward: '#ef5350'
                    }
                }
            },
            grid: {
                borderColor: isDark ? '#3a3a3a' : '#e1e1e1'
            },
            theme: {
                mode: isDark ? 'dark' : 'light'
            }
        };

        candlestickChart = new ApexCharts(chartContainer, options);
        candlestickChart.render();
    }

    // Load candles data
    async function loadCandles() {
        try {
            const response = await fetch('/api/replay/candles');
            const data = await response.json();

            if (data.success && data.candles.length > 0) {
                const tbody = document.getElementById('candles-tbody');
                const countSpan = document.getElementById('candles-count');
                const lastCloseSpan = document.getElementById('last-close');

                countSpan.textContent = data.count;

                const lastCandle = data.candles[data.candles.length - 1];
                lastCloseSpan.textContent = lastCandle.close.toFixed(2);

                // Update table
                tbody.innerHTML = data.candles.map((candle, index) => {
                    const date = new Date(candle.timestamp);
                    const timeStr = date.toLocaleString('fr-FR');

                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${timeStr}</td>
                            <td>${candle.open.toFixed(2)}</td>
                            <td>${candle.high.toFixed(2)}</td>
                            <td>${candle.low.toFixed(2)}</td>
                            <td>${candle.close.toFixed(2)}</td>
                            <td>${candle.volume.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Update chart
                if (!candlestickChart) {
                    initCandlestickChart();
                }

                if (candlestickChart) {
                    const chartData = data.candles.map(candle => ({
                        x: new Date(candle.timestamp),
                        y: [candle.open, candle.high, candle.low, candle.close]
                    }));

                    // Update chart data
                    if (data.candles.length !== lastCandleCount) {
                        candlestickChart.updateSeries([{
                            data: chartData
                        }]);
                        lastCandleCount = data.candles.length;
                    }
                }
            }
        } catch (error) {
            console.error('Failed to load candles:', error);
        }
    }

    // Load logs data
    async function loadLogs() {
        try {
            const response = await fetch('/api/replay/logs?limit=100');
            const data = await response.json();

            if (data.success && data.logs.length > 0) {
                const container = document.getElementById('logs-container');
                const autoScroll = document.getElementById('auto-scroll-checkbox').checked;

                const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

                container.innerHTML = data.logs.map(log => {
                    const date = new Date(log.timestamp);
                    const timeStr = date.toLocaleTimeString('fr-FR');

                    let levelClass = 'log-info';
                    if (log.level === 'error') levelClass = 'log-error';
                    else if (log.level === 'warning') levelClass = 'log-warning';
                    else if (log.level === 'success') levelClass = 'log-success';

                    return `
                        <div class="log-entry ${levelClass}">
                            <span class="log-time">${timeStr}</span>
                            <span class="log-message">${log.message}</span>
                        </div>
                    `;
                }).join('');

                // Auto-scroll to bottom if enabled and was near bottom
                if (autoScroll && wasAtBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            }
        } catch (error) {
            console.error('Failed to load logs:', error);
        }
    }

    // Clear logs display
    function clearLogsDisplay() {
        const container = document.getElementById('logs-container');
        container.innerHTML = `
            <div class="log-entry log-info">
                <span class="log-time">--:--:--</span>
                <span class="log-message">Affichage effac√© (les logs serveur sont conserv√©s)</span>
            </div>
        `;
    }
</script>
</body>
</html>